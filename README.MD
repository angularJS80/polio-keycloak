# ğŸ” polio-keycloak

Spring Cloud Gatewayì—ì„œ [Keycloak](https://www.keycloak.org/)ê³¼ ì—°ë™í•˜ì—¬ URIë³„ ì¸ê°€ ì •ì±…ì„ ìë™ êµ¬ì„±í•˜ëŠ” SDKì…ë‹ˆë‹¤.

> ì¸ê°€ ë¡œì§ì„ ì½”ë“œì—ì„œ ë¶„ë¦¬í•˜ê³ , Keycloak ì •ì±…ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ—ï¸ polio ì¸ê°€ ì•„í‚¤í…ì²˜

Keycloak ê¸°ë°˜ì˜ ë™ì  ì¸ê°€ êµ¬ì¡°ë¥¼ Spring Cloud Gatewayì— ì—°ë™í•˜ì—¬, ì‹¤ì‹œê°„ ê¶Œí•œ ë°˜ì˜ê³¼ API ë³´í˜¸ë¥¼ ì‹¤í˜„í•©ë‹ˆë‹¤.

---

### ğŸ“Œ êµ¬ì„±ìš”ì†Œ ì—­í•  ë¶„ë¦¬

#### ğŸ§© `polio-gateway`
> **ì¸ê°€ ë¬¸ì§€ê¸° + API ì „ë‹¬ì**

- í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ìˆ˜ì‹ 
- HTTP Method / URL ê¸°ë°˜ Scope ì¶”ë¡ 
- `polio-keycloak` SDK í˜¸ì¶œ â†’ Keycloak UMA Ticket ì¸ê°€ ìœ„ì„
- ì¸ê°€ ì„±ê³µ ì‹œ API ì „ë‹¬, ì‹¤íŒ¨ ì‹œ 403 ë°˜í™˜

#### ğŸ§© `polio-keycloak`
> **Keycloak ì—°ë™ SDK (Gateway ë‚´ë¶€ í¬í•¨)**

- Keycloak Resource, Scope, Permission ìë™ ì¡°íšŒ ë° ë§¤í•‘
- Protection API ê¸°ë°˜ ì¸ê°€ ìš”ì²­ ìƒì„±
- `grant_type=uma-ticket` ê¸°ë°˜ ì¸ê°€ ìš”ì²­ ìˆ˜í–‰
- Gatewayì˜ ì¸ê°€ ì²˜ë¦¬ í•µì‹¬

#### ğŸ§© `polio-api`
> **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‹´ë‹¹ API**

- ì¸ê°€ ë¡œì§ì€ ì—†ìŒ
- Gatewayë¥¼ í†µí•´ ë³´í˜¸ë˜ë©°, ì¸ê°€ëœ ìš”ì²­ë§Œ ìˆ˜ì‹ 
- ì •ì±… ë³€ê²½ ì‹œ ì¬ë°°í¬ ë¶ˆí•„ìš”

---

### ğŸ”„ ìš”ì²­ íë¦„

```plaintext
[Client]
   |
   | HTTP ìš”ì²­
   v
[polio-gateway]
   |
   | â†’ URI ë° Method ê¸°ë°˜ Scope ì¶”ë¡ 
   | â†’ polio-keycloak SDK í˜¸ì¶œ
   | â†’ Keycloakì— ì¸ê°€ ìš”ì²­ (UMA Ticket)
   |
   | (ì¸ê°€ í†µê³¼ ì‹œ)
   v
[polio-api] â† ì‹¤ì œ ìš”ì²­ ì²˜ë¦¬


---

## ğŸ“¦ ì„¤ì¹˜ (Gradle)

```groovy
implementation 'com.github.angularJS80:polio-keycloak:f26432e4'

## ğŸ’¡ ì ìš© ì˜ˆì‹œ (`polio-gateway`)

Spring Cloud Gatewayì—ì„œ `polio-keycloak`ì„ í™œìš©í•´ URI ê¸°ë°˜ ì¸ê°€ ì²˜ë¦¬ë¥¼ êµ¬ì„±í•œ ì˜ˆì‹œì…ë‹ˆë‹¤.

---

### ğŸ”§ 1. Security Config ì„¤ì •

```java
http
  .authorizeExchange(authz -> {
      permissionRuleUriMapper.configureAuthorization(authz); // URIë³„ ì¸ê°€ ì„¤ì •
      authz.anyExchange().authenticated(); // ê¸°ë³¸ì ìœ¼ë¡œ ì¸ì¦ í•„ìš”
  })
  .oauth2ResourceServer(oauth2 -> 
      oauth2.jwt(jwt -> 
          jwt.jwtAuthenticationConverter(converter.buildConverter())
      )
  );

---

## ğŸ› ï¸ 2. PermissionRuleUriMapper êµ¬í˜„

Keycloakì—ì„œ ê°€ì ¸ì˜¨ URI ë° Permission ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ê°€ ì²˜ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

```java
@Component
@RequiredArgsConstructor
public class PermissionRuleUriMapper {

    private final KeycloakPermissionService keycloakPermissionService;

    public void configureAuthorization(ServerHttpSecurity.AuthorizeExchangeSpec authz) {
        keycloakPermissionService.getUris().forEach(uri -> {
            if (keycloakPermissionService.isNoPermission(uri)) {
                authz.pathMatchers(uri).permitAll(); // ì¸ì¦ ì—†ì´ ì ‘ê·¼ í—ˆìš©
            } else {
                authz.pathMatchers(uri)
                     .access((authentication, context) -> check(authentication, context, uri));
            }
        });
    }

    private Mono<AuthorizationDecision> check(Mono<Authentication> authentication, AuthorizationContext context, String uri) {
        return authentication.map(auth -> 
            new AuthorizationDecision(keycloakPermissionService.umaCheck(context, auth, uri))
        );
    }
}

## ğŸ” 3. Keycloak ì „ìš© JWT ê¶Œí•œ ë³€í™˜ê¸°

Keycloakì—ì„œ ë°œê¸‰í•œ JWTì˜ í´ë ˆì„(`realm_access`, `resource_access` ë“±)ì—ì„œ ê¶Œí•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ `GrantedAuthority`ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ì´ ë³€í™˜ê¸°ëŠ” Spring Securityì˜ `ReactiveJwtAuthenticationConverter`ì— ì—°ê²°ë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.

### ğŸ“¦ í´ë˜ìŠ¤: `KeycloakReactiveJwtAuthenticationConverter`

```java
package com.polio.gateway.security.converter;

import com.polio.gateway.security.util.JwtUtil;
import com.polio.poliokeycloak.keycloak.client.prop.KeycloakSecurityProperties;
import lombok.RequiredArgsConstructor;
import org.springframework.core.convert.converter.Converter;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.security.oauth2.server.resource.authentication.ReactiveJwtAuthenticationConverter;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;

import java.util.*;

@Component
@RequiredArgsConstructor
public class KeycloakReactiveJwtAuthenticationConverter implements Converter<Jwt, Flux<GrantedAuthority>> {

    private final KeycloakSecurityProperties keycloakSecurityProperties;

    @Override
    public Flux<GrantedAuthority> convert(Jwt jwt) {
        return Flux.fromIterable(JwtUtil.convertAuthorities(jwt, keycloakSecurityProperties.getClientId()));
    }

    public ReactiveJwtAuthenticationConverter buildConverter() {
        ReactiveJwtAuthenticationConverter converter = new ReactiveJwtAuthenticationConverter();
        converter.setJwtGrantedAuthoritiesConverter(this); // í˜„ì¬ í´ë˜ìŠ¤ê°€ converter ì—­í• ì„ ìˆ˜í–‰
        return converter;
    }
}

